## Read in Casal2 output
detach("package:ibm", unload=TRUE)

## this script is just comparing, steady state models just constant recruitment and M
library(ggplot2)
library(reshape2)
library(Casal2)
setwd("../Casal2")

cas2 = extract.mpd("run.log")
cas2_dq = plot.derived_quantities(cas2, report_label = "biomass_t1", plot.it = F)

## Read in the IBM output
setwd("../ibm")
library(ibm)

ibm = extract.run("run.log")
#ibm2 = extract.run("run.log")

abm_col = "red"
cas_col = "black"
names(ibm)

ibm_dq = plot.derived_quantities(ibm, report_label = "derived_quants", plot.it = F)
#ibm_dq2 = plot.derived_quantities(ibm2, report_label = "derived_quants", plot.it = F)
#ibm_dq3 = plots.derived_quantities(ibm3, report_label = "derived_quants", plot.it = F)

## compare SSB's
years = as.numeric(rownames(ibm_dq))
plot(years, ibm_dq[,"SSB"], type = "l", lwd = 2, col = abm_col, xlab = "years", ylab = "SSB (t)", ylim = c(0,120000))
lines(years, cas2_dq[,"biomass_t1"], lwd = 2, col = cas_col)
#lines(years, ibm_dq3[,"SSB"], lwd = 2, lty = 2, col = "orange")
legend('bottomleft', legend = c("ABM", "Casal2"), col = c(abm_col,cas_col), lty = c(1,1,1),lwd = 2)

ages = 1:50

## look at Growth
par(mfrow = c(1,3))
plot(ages, cas2$agelength_1$'1975'$mean_length_at_age, type = "l", lwd = 3, col = cas_col)
points( ibm$agents_1$'1976'$values$age, ibm$agents_1$'1976'$values$length, pch = 16, col = abm_col)

plot(ages, cas2$agelength_2$'1975'$mean_length_at_age, type = "l", lwd = 3, col = cas_col)
points( ibm$agents_2$'1976'$values$age, ibm$agents_2$'1976'$values$length, pch = 16, col = abm_col)

plot(ages, cas2$agelength_3$'1975'$mean_length_at_age, type = "l", lwd = 3, col = cas_col)
points( ibm$agents_3$'1976'$values$age, ibm$agents_3$'1976'$values$length, pch = 16, col = abm_col)

## look at Recruitment
paste0(round(cas2$Recruitment$standardised_ycs,3),collapse = " ")
cas2$Recruitment$ycs_values
plot(cas2$Recruitment$ycs_years, cas2$Recruitment$standardised_ycs, type = "o", col = cas_col, lwd = 3)
lines(ibm$Rec$years,ibm$Rec$ycs_values, type = "o", col = abm_col, lwd = 3)

## lets look at fishing age frequency
ibm_comp = ibm$fishing$`age_freq-FishingEast` 

## look at age and length relationship
df = ibm3$agents$`3`$values
df1 = ibm$agents$`3`$values

plot(df$age, df$length,pch = 19, xlab = "age", ylab = "length", main = "age length of 1000 agents")
points(df1$age, df1$length,pch = 19, col = "red")

## look at age frequencies
casal2_model = as.numeric(cas2$init_part$values[2:31] / sum(cas2$init_part$values[2:31]))
ibm_model = as.numeric(ibm$init_2$values / sum(ibm$init_2$values))

## reformat for GGPLOT
new_data_prop = melt(data.frame(casal2_model,ibm_model), variable.name = "model")
new_data_prop$age = c(1:30,1:30)
casal2_model = as.numeric(cas2$init_part$values[2:31])
ibm_model = as.numeric(ibm$init_2$values )

new_data = melt(data.frame(casal2_model,ibm_model), variable.name = "model")
new_data$age = c(1:30,1:30)

jpeg("initial_age_distribution.jpg")
ggplot(new_data,aes(x=age,y=value,fill=model))+
  geom_bar(stat="identity",position="dodge")+
  scale_fill_discrete(name="Model",
                      labels=c("Casal2", "IBM","IBM latest"))+ 
  xlab("Age")+ylab("Proportion") + 
  ggtitle("Initial age distribution")
dev.off()

jpeg("initial_proportion_age_distribution.jpg")
ggplot(new_data_prop,aes(x=age,y=value,fill=model))+
  geom_bar(stat="identity",position="dodge")+
  scale_fill_discrete(name="Model",
  labels=c("Casal2", "IBM","IBM latest"))+ 
  xlab("Age")+ylab("Proportion") + 
  ggtitle("Initial age distribution")
dev.off()


casal2_model = as.numeric(cas2$Annual_part$'53'$values[2:32] / sum(cas2$Annual_part$'53'$values[2:31]))
ibm_model = as.numeric(ibm$total_age_freq$`53`$values / sum(ibm$total_age_freq$`53`$values))
ibm_model2 = as.numeric(ibm2$total_age_freq$`53`$values / sum(ibm2$total_age_freq$`53`$values))

## reformat for GGPLOT
new_data = melt(data.frame(casal2_model,ibm_model,ibm_model2), variable.name = "model")
new_data$age = c(0:30,0:30,0:30)
jpeg("final_age_distribution.jpg")
ggplot(new_data,aes(x=age,y=value,fill=model))+
  geom_bar(stat="identity",position="dodge")+
  scale_fill_discrete(name="Model",
  labels=c("Casal2", "IBM","IBM latest"))+ 
  xlab("Age")+ylab("Proportion") + 
  ggtitle("Final age distribution")
dev.off()
## look at the fisher age distribution


