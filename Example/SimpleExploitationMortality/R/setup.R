#'
#'
#' Validate U based mortality with CASAL2
#'

library(Casal2)
library(r4Casal2)
library(ibm)
cas = extract.mpd(file = "run.log", path = file.path("..", "Casal2"))
abm_dir = file.path("..", "ibm")
abm_layer_dir = file.path(abm_dir, "Layers")
cas$Recruitment$r0

len_bins = seq(from = 2, 140, by = 2)
paste0(len_bins, collapse = " ")

#########
## Recruitment
###########
paste0(round(cas$Recruitment$standardised_ycs,3),collapse = " ")

#########
## Fishing
##########
fish_us = cbind(cas$instant_mort$`fishing_pressure[FishingEast]`,cas$instant_mort$`fishing_pressure[FishingWest]`)
fish_years = cas$instant_mort$year

fishery_labs = c("FishingEast", "FishingWest")
## create U layers
u_layer_dir = normalizePath(file.path(abm_layer_dir, "U_layers"))
if(!dir.exists(u_layer_dir)) {
  dir.create(u_layer_dir)
}

include_names = c()
u_config_table = NULL 
for(i in 1:length(fish_years)) {
  temp_record = c(fish_years[i])
  for(f in 1:length(fishery_labs)) {
    file_name = file.path(u_layer_dir, paste0(fishery_labs[f], "_U_", fish_years[i], ".ibm"))
    create_ibm_layer(label = paste0(fishery_labs[f], "_U_", fish_years[i]), type = "numeric", filename = file_name, Matrix = matrix(fish_us[i, f], nrow = 1))
    include_names = c(include_names, paste0("!include Layers/U_layers/", paste0(fishery_labs[f], "_U_", fish_years[i], ".ibm")))
    temp_record = c(temp_record, paste0(fishery_labs[f], "_U_", fish_years[i]))
  }
  u_config_table = rbind(u_config_table, temp_record)
}
write.table((include_names), file = file.path(abm_dir, paste0("includes.ibm")), quote = F, row.names = F, col.names = F)

u_config_table = matrix(u_config_table, ncol =3)
write.table((u_config_table), file = file.path(abm_dir, paste0("Fishing_u_table.ibm")), quote = F, row.names = F, col.names = F)
