---
title: "How to interact With CASAL"
author: "C.Marsh"
date: "09/06/2020"
output: pdf_document
bibliography: bibliography.bib
citation_package: natbib

header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts=list(width.cutoff=60),tidy=TRUE)
```


```{r wrap-hook, include=FALSE}
library(knitr)
```

## Introduction

The aim of this document is to demonstrate how to use the abm to simualte data, and then some R-code on how you would read that simulated data in to other packages, in this case CASAL.


System requirements
\begin{itemize}
  \item The following R-libraries installed
  \subitem \texttt{library(casal)}
  \subitem \texttt{library(ibm)}
  \subitem \texttt{library(ggplot2)}
  \subitem \texttt{library(Dataweighting)} for if you are applying data-weighting methods in simualtions.
\end{itemize}



```{r set_library, linewidth=60, echo=TRUE}
library(casal)
library(ibm)
library(ggplot2)
library(DataWeighting)
```


## Read in a Single run
When the abm to get an idea on model behaviour using the following command in terminal \texttt{ibm -r > run.log}. If you want the abm to simulate multiple datasets there are a few methods. Firstly simulate data based on one process model cycle. This will run from start year to final year only once, and then simulate multiple datasets with observation error but the same expected value. This is done using the commnad \texttt{ibm -s 10 > sim.out}. Remember that you will need to include the \texttt{@report}block for simulated data \textbf{Note} you want to write each observation to a seperate file, look in \texttt{reports.ibm} for an example. The alternative is to simulate a single dataset after each model cycle with multiple model cycles. This is done by supplying an input file \texttt{ibm -s 1 -i pars.txt > sim\_multi.out}, the disadvantage to this, is it can be a lot slower if it takes 1-2 minutes to complete a model cycle then 10 simualtions will take 10 minutes, but adds process variability. This will be needed for the tag-recapture observations as well.


```{r read_mpd_single, linewidth=60}
# this will create a list-like object called single_run
single_run <- extract.run(file = file.path("..","abm","run.log"))
# list of reports
names(single_run)
with_time_vary_m <- extract.run(file = file.path("..","abm","run_time_vary.out"))

plot.derived_quantities(single_run, report_label = "derived_quants")
time_vary_ssb = with_time_vary_m$derived_quants$SSB
lines(names(time_vary_ssb$values), time_vary_ssb$values, lwd = 3, col = "red", lty = 2)

## plot age-length
plot(single_run$agents$`1975`$values$age, single_run$agents$`1975`$values$length, ylim = c(0,140), xlab = "Age", ylab = "Length (cm)", pch = 16)

## check time-vary M applied correctly
plot(with_time_vary_m$time_vary$natMort$year, with_time_vary_m$time_vary$natMort$Value, type = "l", lwd = 3, ylim = c(0,0.4))
years = as.numeric(names(with_time_vary_m$agents)[names(with_time_vary_m$agents) != "type"], xlab = "Year", ylab = "M")
for(i in 1:length(years)) {
  this_ndx = with_time_vary_m$agents[[which(names(with_time_vary_m$agents) == years[i])]]
  points(years[i], mean(this_ndx$values$M), col = "red", pch = 16, cex = 1.2)
}
## plot observation over the time-horizon
#obs_time_series = plot_obs_timeseries(model_years = single_run$model_attributes$model_years, ibm_model = single_run)
#obs_time_series
```


## Run a ReEstiamtion
```{r reestimate, linewidth=60, eval=F, echo = T}
# Get location of simulated data
abm <- extract.run(file = file.path("..","abm","run.log"))

sim_obs = file.path("..","abm", "sim")
sim_file_names = unique(sapply(strsplit(list.files(sim_obs), split = "\\."), "[", 1))
extensions = unique(sapply(strsplit(list.files(sim_obs), split = "\\."), "[", 2))
N_sims = length(extensions)
SSBs = list();
output_list = list()

## read in Casal estiamtion csl file
cas_mpd = casal::extract.csl.file(file = file.path("..","CASAL","estimation.csl"))
## make a copy for safe keepings
#casal::write.csl.file(cas_mpd, file = file.path("..","CASAL","estimation_orig.csl"))

sim_chat_bio_ndx = which(sim_file_names %in% "chatTANbiomass")
sim_chat_age_ndx = which(sim_file_names %in% "chatTANage")
sim_east_ndx = which(sim_file_names %in% "chatOBSest")
sim_west_ndx = which(sim_file_names %in% "chatOBSwst")


################
## Main loop
## this will have to be manually edited
###############
abm_ages = abm$model_attributes$ages

for(sim in 1:N_sims) {
  # Chat bio
  sim_ibm = ibm::extract.ibm.file(file = file.path(sim_obs, paste0(sim_file_names[sim_chat_bio_ndx],".",extensions[sim])))
  year_ndx = match(sim_ibm$`observation[chatTANbiomass_sim]`$years$value, names(cas_mpd$`relative_abundance[chatTANbiomass]`))
  for(i in 1:length(year_ndx))
    cas_mpd$`relative_abundance[chatTANbiomass]`[[year_ndx[i]]] = sim_ibm$`observation[chatTANbiomass_sim]`$obs$value[i]
  # Chat age
  sim_ibm = ibm::extract.ibm.file(file = file.path(sim_obs, paste0(sim_file_names[sim_chat_age_ndx],".",extensions[sim])))
  year_ndx = match(sim_ibm$`observation[chatTANage_sim]`$years$value, names(cas_mpd$`proportions_at[chatTANage]`))
  max_age = as.numeric(cas_mpd$`proportions_at[chatTANage]`$max_class)
  min_age = as.numeric(cas_mpd$`proportions_at[chatTANage]`$min_class)
  for(i in 1:length(year_ndx)) {
    cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]] = as.numeric(sim_ibm$`observation[chatTANage_sim]`$Table$obs[[i]]) / sum(as.numeric(sim_ibm$`observation[chatTANage_sim]`$Table$obs[[i]]))
    ## truncate
    if (cas_mpd$`proportions_at[chatTANage]`$plus_group %in% c("1","TRUE","T","True"))
      cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]][max_age] = sum(cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]][max_age:length(sim_ibm$`observation[chatTANage_sim]`$Table$obs[[i]])])
    cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]] = cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]][min_age:max_age]
    cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]]= cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]] / sum(cas_mpd$`proportions_at[chatTANage]`[[year_ndx[i]]])
  }
  # Chat west
  sim_ibm = ibm::extract.ibm.file(file = file.path(sim_obs, paste0(sim_file_names[sim_west_ndx],".",extensions[sim])))
  year_ndx = match(sim_ibm$`observation[chatOBSwst_sim]`$years$value, names(cas_mpd$`catch_at[chatOBSwst]`))
  max_age = as.numeric(cas_mpd$`catch_at[chatOBSwst]`$max_class)
  min_age = as.numeric(cas_mpd$`catch_at[chatOBSwst]`$min_class)
  for(i in 1:length(year_ndx)) {
    cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]] = as.numeric(sim_ibm$`observation[chatOBSwst_sim]`$Table$obs[[i]]) / sum(as.numeric(sim_ibm$`observation[chatOBSwst_sim]`$Table$obs[[i]]))
    ## truncate
    if (cas_mpd$`catch_at[chatOBSwst]`$plus_group %in% c("1","TRUE","T","True"))
      cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]][max_age] = sum(cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]][max_age:length(sim_ibm$`observation[chatOBSwst_sim]`$Table$obs[[i]])])
    cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]] = cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]][min_age:max_age]
    cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]]= cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]] / sum(cas_mpd$`catch_at[chatOBSwst]`[[year_ndx[i]]])
  }
  
  # Chat east
  sim_ibm = ibm::extract.ibm.file(file = file.path(sim_obs, paste0(sim_file_names[sim_east_ndx],".",extensions[sim])))
  year_ndx = match(sim_ibm$`observation[chatOBSest_sim]`$years$value, names(cas_mpd$`catch_at[chatOBSest]`))
  max_age = as.numeric(cas_mpd$`catch_at[chatOBSest]`$max_class)
  min_age = as.numeric(cas_mpd$`catch_at[chatOBSest]`$min_class)
  for(i in 1:length(year_ndx)) {
    cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]] = as.numeric(sim_ibm$`observation[chatOBSest_sim]`$Table$obs[[i]]) / sum(as.numeric(sim_ibm$`observation[chatOBSest_sim]`$Table$obs[[i]]))
    ## truncate
    if (cas_mpd$`catch_at[chatOBSest]`$plus_group %in% c("1","TRUE","T","True"))
      cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]][max_age] = sum(cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]][max_age:length(sim_ibm$`observation[chatOBSest_sim]`$Table$obs[[i]])])
    cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]] = cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]][min_age:max_age]
    cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]]= cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]] / sum(cas_mpd$`catch_at[chatOBSest]`[[year_ndx[i]]])
  }
  ## write estimation.csl.
  casal::write.csl.file(cas_mpd, file = file.path("..","CASAL","estimation.csl"))
  
  ## estimate and data weighting
  setwd(file.path("..","CASAL"))
  for(i in 1:5) {
    shell(paste0("cmd & casal -e > ReEstimateStand\\mpd_",sim,".out 2> AD.out"))
    est_mpd = casal::extract.mpd(paste0("ReEstimateStand\\mpd_",sim,".out"))
    cas_mpd_est_alt = casal::extract.csl.file(file = file.path("..","CASAL","estimation.csl"))
    error_ndx = grepl(names(cas_mpd_est_alt$`proportions_at[chatTANage]`), pattern = "N_")
    chat_age_weight = Method.TA1.8(est_mpd$fits$chatTANage, plotit = T)
    cas_mpd_est_alt$`proportions_at[chatTANage]`[error_ndx] = lapply(cas_mpd_est_alt$`proportions_at[chatTANage]`[error_ndx], FUN = function(x) {as.numeric(x) * chat_age_weight})
    
    error_ndx = grepl(names(cas_mpd_est_alt$`catch_at[chatOBSwst]`), pattern = "N_")
    chat_west_weight = Method.TA1.8(est_mpd$fits$chatOBSwst, plotit = F)
    cas_mpd_est_alt$`catch_at[chatOBSwst]`[error_ndx] = lapply(cas_mpd_est_alt$`catch_at[chatOBSwst]`[error_ndx], FUN = function(x) {as.numeric(x) * chat_west_weight})
    
    error_ndx = grepl(names(cas_mpd_est_alt$`catch_at[chatOBSest]`), pattern = "N_")
    chat_east_weight = Method.TA1.8(est_mpd$fits$chatOBSest, plotit = F)
    cas_mpd_est_alt$`catch_at[chatOBSest]`[error_ndx] = lapply(cas_mpd_est_alt$`catch_at[chatOBSest]`[error_ndx], FUN = function(x) {as.numeric(x) * chat_east_weight})
    casal::write.csl.file(object = cas_mpd, file = file.path("..","CASAL","estimation.csl"))
  }
}

```




